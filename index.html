<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cisco Switch Map Viewer - Puerto Rico</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SheetJS (xlsx) for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map {
            height: 65vh;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            background: #f3f4f6;
        }
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; }
        .legend { line-height: 18px; color: #555; }
        select[multiple] { height: 100px; }

        /* Floating Content Viewer Styles */
        #content-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #viewer-header {
            width: 90%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: white;
        }
        #viewer-container {
            width: 90%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #111;
            border-radius: 8px;
            border: 1px solid #333;
            overflow: auto;
        }
        #viewer-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            background: #222;
        }
        .viewer-btn {
            background: #4f46e5;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            text-decoration: none;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .viewer-btn:hover { background: #4338ca; }
        .close-x {
            color: white;
            font-size: 40px;
            line-height: 1;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        #viewer-copy-btn {
            background: #10b981;
        }
        #viewer-copy-btn:hover { background: #059669; }

        /* Loading Spinner */
        #viewer-loader {
            display: none;
            position: absolute;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Content Viewer Overlay -->
    <div id="content-viewer">
        <div id="viewer-header">
            <div id="viewer-title" class="font-bold text-lg truncate pr-4"></div>
            <div class="flex gap-3 items-center shrink-0">
                <button id="viewer-copy-btn" class="viewer-btn">Copy Path</button>
                <a id="viewer-external" href="#" target="_blank" class="viewer-btn">Open in SharePoint</a>
                <button onclick="closeViewer()" class="close-x">&times;</button>
            </div>
        </div>
        <div id="viewer-container">
            <div id="viewer-loader"></div>
            <img id="viewer-img" src="" alt="Deployment Photo" referrerpolicy="no-referrer">
        </div>
        <div class="text-gray-400 text-xs mt-4 text-center max-w-2xl px-4">
            If the image doesn't appear, use <b>"Open in SharePoint"</b>. Browser security may block photos if you aren't logged into SharePoint in this session.
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">Cisco Switch Map Viewer</h1>
            <p class="text-gray-600 mt-2 font-medium">Puerto Rico Master Inventory & Deployment Visualization</p>
        </header>

        <!-- Upload Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex-1 w-full">
                    <label for="file-upload" class="block text-sm font-semibold text-gray-700 mb-2">Upload Master Inventory (.xlsx)</label>
                    <div class="flex items-center gap-2">
                        <input id="file-upload" type="file" accept=".xlsx" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                            file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700
                            hover:file:bg-indigo-100 transition-colors cursor-pointer">
                        <button id="load-data" class="px-5 py-2 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 shadow-sm transition-all">Load Data</button>
                    </div>
                </div>
                <div class="text-center md:text-right">
                     <a href="#" id="download-sample" class="text-sm font-semibold text-indigo-600 hover:underline">Download Template</a>
                </div>
            </div>
             <div id="loading" class="text-center mt-4 hidden">
                <p class="text-indigo-600 font-bold animate-pulse">Loading Inventory...</p>
            </div>
             <div id="error-message" class="text-center mt-4 text-red-600 hidden font-medium p-3 bg-red-50 rounded-md border border-red-100"></div>
        </div>

        <!-- Filters Section -->
        <div id="filter-section" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden border border-gray-200">
            <h3 class="text-lg font-bold mb-4 text-gray-900 flex items-center gap-2">Filters</h3>
            <div id="filter-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Location Type</label>
                    <select id="type-filter" multiple class="block w-full rounded border-gray-300 text-sm p-2"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Inventory Model</label>
                    <select id="switch-model-filter" multiple class="block w-full rounded border-gray-300 text-sm p-2"></select>
                </div>
                <div id="network-filter-wrapper">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Network Segment</label>
                    <select id="network-filter" multiple class="block w-full rounded border-gray-300 text-sm p-2"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Deployment Schedule</label>
                    <div class="space-y-2">
                        <input type="date" id="date-from" class="block w-full rounded border-gray-300 text-sm p-1">
                        <input type="date" id="date-to" class="block w-full rounded border-gray-300 text-sm p-1">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-3 border-t pt-4">
                <button id="apply-filters" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 shadow-sm transition-all">Apply Filters</button>
                <button id="clear-filters" class="px-6 py-2 bg-gray-100 text-gray-600 font-bold rounded-md hover:bg-gray-300 transition-all">Reset All</button>
            </div>
        </div>

        <div id="map"></div>
         
        <div id="status-message" class="mt-4 text-gray-500 text-sm text-center py-4">
            Upload a Master Inventory file to begin.
        </div>

        <footer class="mt-8 text-center text-gray-400 text-[10px] uppercase tracking-widest pb-8">
            Version: 0202 | Build: 2029
        </footer>
    </div>

    <script>
        // --- Global Variables & Icons ---
        let allSwitchData = [];
        let map, markers;

        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const blackIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // SharePoint Configuration
        const sharePointBase = "https://intwoglobal-my.sharepoint.com/personal/luis_ramirez_intwo_cloud/Documents/First%20Bank%20Swtiches%202026%20Shared/Fotos%20Serial%20y%20Tag/";
        const sharePointSuffix = ".jpeg?csf=1&web=1&e=eg9pzT";

        window.onload = function() { initMap(); };

        function initMap() {
            try {
                map = L.map('map').setView([18.2208, -66.5901], 9);
                markers = L.layerGroup().addTo(map);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function() {
                    const div = L.DomUtil.create('div', 'legend bg-white p-3 rounded shadow-lg border border-gray-100');
                    div.innerHTML = `<h4 class="font-bold text-xs uppercase text-gray-400 mb-2 border-b pb-1">Legend</h4>
                        <div class="flex items-center mb-1"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png" class="w-3 mr-2"> <span class="text-xs">Complete</span></div>
                        <div class="flex items-center mb-1"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png" class="w-3 mr-2"> <span class="text-xs">Branch</span></div>
                        <div class="flex items-center"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png" class="w-3 mr-2"> <span class="text-xs">Moex / Other</span></div>`;
                    return div;
                };
                legend.addTo(map);
            } catch (e) { console.error("Map failed:", e); }
        }

        // --- Content Viewer ---
        window.openViewer = function(url, title) {
            const viewer = document.getElementById('content-viewer');
            const img = document.getElementById('viewer-img');
            const titleEl = document.getElementById('viewer-title');
            const extLink = document.getElementById('viewer-external');
            const copyBtn = document.getElementById('viewer-copy-btn');
            const loader = document.getElementById('viewer-loader');
            
            titleEl.textContent = title;
            extLink.href = url;
            
            // Show loader, hide image until loaded
            loader.style.display = 'block';
            img.style.opacity = '0';
            img.src = url;
            
            img.onload = () => {
                loader.style.display = 'none';
                img.style.opacity = '1';
            };
            
            img.onerror = () => {
                loader.style.display = 'none';
            };

            copyBtn.onclick = () => {
                const tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy Path', 2000);
            };

            viewer.style.display = 'flex';
        };

        window.closeViewer = function() {
            const viewer = document.getElementById('content-viewer');
            document.getElementById('viewer-img').src = '';
            viewer.style.display = 'none';
        };

        // --- Data Helpers ---
        function getRowValue(row, possibleNames) {
            for (let name of possibleNames) {
                if (row.hasOwnProperty(name)) return row[name];
                const match = Object.keys(row).find(k => k.toLowerCase().trim() === name.toLowerCase().trim());
                if (match) return row[match];
            }
            return undefined;
        }

        function getTagValue(row, switchNum, isNew = false) {
            if (isNew) {
                if (switchNum === 1) return row['Tag 1_1'] || row['Tag 1'] || '-';
                if (switchNum === 2) return row['Tag 2_1'] || '-';
                if (switchNum === 3) return row['Tag 3_1'] || '-';
            } else {
                if (switchNum === 1) return row['TAG 1'] || '-';
                if (switchNum === 2) return row['Tag 2'] || '-';
                if (switchNum === 3) return row['Tag 3'] || '-';
            }
            return '-';
        }

        function renderNewTagLink(tagValue) {
            let tag = String(tagValue || '').trim();
            if (!tag || tag === '-' || tag.toLowerCase() === 'n/a') return '-';
            // Strip leading # if present
            if (tag.startsWith('#')) tag = tag.substring(1);
            const fullUrl = `${sharePointBase}${encodeURIComponent(tag)}${sharePointSuffix}`;
            return `<a href="${fullUrl}" onclick="event.preventDefault(); window.openViewer('${fullUrl}', 'Tag Photo - ${tag}')" class="text-indigo-600 hover:text-indigo-800 underline font-bold">#${tag}</a>`;
        }

        function renderDeploymentImageLinks(ip) {
            const rawIp = String(ip || '').trim();
            if (!rawIp || rawIp === '-' || rawIp.toLowerCase() === 'n/a') return '';
            const dashIp = rawIp.replace(/\./g, '-');
            const beforeUrl = `${sharePointBase}a${dashIp}${sharePointSuffix}`;
            const afterUrl = `${sharePointBase}d${dashIp}${sharePointSuffix}`;
            return `
                <div class="flex gap-2 mt-1">
                    <a href="${beforeUrl}" onclick="event.preventDefault(); window.openViewer('${beforeUrl}', 'Before Photo - ${rawIp}')" class="text-[10px] bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200 hover:bg-amber-200 font-bold no-underline inline-block">Before</a>
                    <a href="${afterUrl}" onclick="event.preventDefault(); window.openViewer('${afterUrl}', 'After Photo - ${rawIp}')" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded border border-emerald-200 hover:bg-emerald-200 font-bold no-underline inline-block">After</a>
                </div>`;
        }

        // --- Core UI Logic ---
        const fileUpload = document.getElementById('file-upload');
        const loadDataButton = document.getElementById('load-data');
        const loadingIndicator = document.getElementById('loading');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const filterSection = document.getElementById('filter-section');
        const typeSelect = document.getElementById('type-filter');
        const modelSelect = document.getElementById('switch-model-filter');
        const networkSelect = document.getElementById('network-filter');
        const dateFromInput = document.getElementById('date-from');
        const dateToInput = document.getElementById('date-to');

        loadDataButton.addEventListener('click', handleFileUpload);
        document.getElementById('apply-filters').addEventListener('click', plotDataOnMap);
        document.getElementById('clear-filters').addEventListener('click', () => {
            [modelSelect, typeSelect, networkSelect].forEach(s => Array.from(s.options).forEach(o => o.selected = false));
            plotDataOnMap();
        });

        function handleFileUpload() {
            const file = fileUpload.files[0];
            if (!file) return;
            showLoading(true);
            hideError();
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (json.length === 0) throw new Error("File empty");
                    allSwitchData = json;
                    initializeFilters(allSwitchData);
                    plotDataOnMap();
                    filterSection.classList.remove('hidden');
                } catch (err) { showError("Error reading file."); }
                finally { showLoading(false); }
            };
            reader.readAsArrayBuffer(file);
        }

        function initializeFilters(data) {
            const models = new Set(), types = new Set(), networks = new Set(), dates = [];
            data.forEach(row => {
                ['Switch 1', 'Switch 2', 'Switch 3'].forEach(h => {
                    const m = getRowValue(row, [h]);
                    if (m && String(m).toUpperCase() !== 'N/A') models.add(String(m).trim());
                });
                const t = getRowValue(row, ['Branch or Moex', 'Type']);
                if (t) types.add(String(t).trim());
                const n = getRowValue(row, ['NETWORK', 'Network', 'Segment']);
                if (n && String(n).toUpperCase() !== 'N/A') networks.add(String(n).trim());
                const d = parseToDate(getRowValue(row, ['Date', 'Installation Date']));
                if (d) dates.push(d);
            });
            populateSelect(modelSelect, models);
            populateSelect(typeSelect, types);
            populateSelect(networkSelect, networks);
            if (dates.length > 0) {
                dateFromInput.value = new Date(Math.min(...dates)).toISOString().split('T')[0];
                dateToInput.value = new Date(Math.max(...dates)).toISOString().split('T')[0];
            }
        }

        function populateSelect(el, set) {
            el.innerHTML = '';
            Array.from(set).sort().forEach(val => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = val;
                el.appendChild(opt);
            });
        }

        function plotDataOnMap() {
            const selModels = Array.from(modelSelect.selectedOptions).map(o => o.value);
            const selTypes = Array.from(typeSelect.selectedOptions).map(o => o.value);
            const selNets = Array.from(networkSelect.selectedOptions).map(o => o.value);
            const from = dateFromInput.value ? new Date(dateFromInput.value) : null;
            const to = dateToInput.value ? new Date(dateToInput.value) : null;
            if (to) to.setHours(23,59,59);

            markers.clearLayers();
            let count = 0, swTotal = 0, sums = {};

            allSwitchData.forEach(row => {
                const lat = parseFloat(getRowValue(row, ['Latitude'])), lon = parseFloat(getRowValue(row, ['Longitude']));
                if (isNaN(lat) || isNaN(lon)) return;

                const rowDate = parseToDate(getRowValue(row, ['Date', 'Installation Date']));
                const s1 = getRowValue(row, ['Switch 1']), s2 = getRowValue(row, ['Switch 2']), s3 = getRowValue(row, ['Switch 3']);
                const type = String(getRowValue(row, ['Branch or Moex', 'Type']) || '').trim();
                const network = String(getRowValue(row, ['NETWORK', 'Network', 'Segment']) || '').trim();
                const closure = getRowValue(row, ['Hora de Cierre', 'Hora de Cieere']) || '-';

                const mMatch = selModels.length === 0 || [s1, s2, s3].some(s => selModels.includes(String(s || '').trim()));
                const tMatch = selTypes.length === 0 || selTypes.includes(type);
                const nMatch = selNets.length === 0 || selNets.includes(network);
                const dMatch = !rowDate || ((!from || rowDate >= from) && (!to || rowDate <= to));

                if (mMatch && tMatch && nMatch && dMatch) {
                    const complete = String(getRowValue(row, ['Complete']) || '').trim().toUpperCase() === 'Y';
                    const icon = complete ? redIcon : (type.toUpperCase() === 'BRANCH' ? greenIcon : blackIcon);
                    
                    const popup = `<div class="min-w-[280px]">
                        <h3 class="font-bold text-gray-900 border-b pb-1 mb-2 text-sm flex justify-between">
                            <span>${getRowValue(row, ['Location']) || 'Site'}</span>
                            <span class="text-[9px] text-indigo-500 font-medium">Close: ${closure}</span>
                        </h3>
                        <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[11px] mb-3">
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Pueblo</span> <span>${getRowValue(row, ['Pueblo']) || '-'}</span></div>
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Network IP</span> <span class="font-mono text-indigo-600">${network || '-'}</span></div>
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Software</span> <span>${getRowValue(row, ['Version']) || '-'}</span></div>
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Deployment</span> <span>${rowDate ? rowDate.toLocaleDateString() : '-'}</span></div>
                        </div>
                        <div class="mb-3">
                            <span class="text-gray-400 font-bold uppercase text-[9px] block mb-1 font-bold">Deployment Photos</span>
                            ${renderDeploymentImageLinks(network)}
                        </div>
                        <div class="bg-gray-50 p-2 rounded border border-gray-200 text-[10px] space-y-2 mb-2">
                            <b class="text-[9px] uppercase text-gray-400 block border-b pb-0.5">Inventory Reference</b>
                            <div><b>Sw1:</b> ${s1 || 'N/A'} <div class="text-gray-400 pl-2">S/N: ${getRowValue(row, ['Serial No-1']) || '-'} | Tag: ${getTagValue(row, 1, false)}</div></div>
                            ${s2 && s2 !== 'N/A' ? `<div><b>Sw2:</b> ${s2} <div class="text-gray-400 pl-2">S/N: ${getRowValue(row, ['Serial No-2']) || '-'} | Tag: ${getTagValue(row, 2, false)}</div></div>` : ''}
                            ${s3 && s3 !== 'N/A' ? `<div><b>Sw3:</b> ${s3} <div class="text-gray-400 pl-2">S/N: ${getRowValue(row, ['Serial No -3']) || '-'} | Tag: ${getTagValue(row, 3, false)}</div></div>` : ''}
                        </div>
                        <div class="bg-indigo-50/50 p-2 rounded border border-indigo-100 text-[10px] space-y-2">
                            <b class="text-[9px] uppercase text-indigo-400 block border-b border-indigo-100 pb-0.5 font-bold">New Deployment Data</b>
                            <div><b class="text-indigo-900">Sw1 New:</b> ${getRowValue(row, ['Serial No. No Switch 1']) || '-'} <div class="pl-2">Tag: ${renderNewTagLink(getTagValue(row, 1, true))}</div></div>
                            ${getRowValue(row, ['Serial No NEW  Switch 2']) ? `<div><b class="text-indigo-900">Sw2 New:</b> ${getRowValue(row, ['Serial No NEW  Switch 2'])} <div class="pl-2">Tag: ${renderNewTagLink(getTagValue(row, 2, true))}</div></div>` : ''}
                            ${getRowValue(row, ['Serial No. W Switch 3']) ? `<div><b class="text-indigo-900">Sw3 New:</b> ${getRowValue(row, ['Serial No. W Switch 3'])} <div class="pl-2">Tag: ${renderNewTagLink(getTagValue(row, 3, true))}</div></div>` : ''}
                        </div>
                    </div>`;

                    L.marker([lat, lon], { icon }).bindPopup(popup).addTo(markers);
                    count++;
                    [s1, s2, s3].forEach(s => {
                        if (s && String(s).toUpperCase() !== 'N/A') {
                            swTotal++;
                            const k = String(s).trim(); sums[k] = (sums[k] || 0) + 1;
                        }
                    });
                }
            });
            updateStatus(count, swTotal, sums);
        }

        function updateStatus(sites, total, sums) {
            if (sites > 0) {
                let breakdown = '<div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-2">';
                Object.keys(sums).sort().forEach(m => { breakdown += `<div class="text-[11px]"><b class="text-gray-600">${m}:</b> ${sums[m]}</div>`; });
                breakdown += '</div>';
                statusMessage.innerHTML = `<div class="bg-white p-4 rounded-lg border text-left">
                    <p class="font-bold text-indigo-900">${sites} Sites matched <span class="font-normal text-gray-400">(${total} units total)</span></p>
                    <p class="text-[10px] uppercase font-bold text-gray-300 mt-3 border-b">Inventory Breakdown</p>${breakdown}</div>`;
                statusMessage.classList.remove('text-center');
            } else {
                statusMessage.innerHTML = "No results found."; statusMessage.classList.add('text-center');
            }
        }

        function parseToDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number' && val > 30000 && val < 60000) return new Date((val - 25569) * 86400 * 1000);
            const d = new Date(val);
            return isNaN(d.getTime()) ? null : d;
        }

        function showLoading(s) { loadingIndicator.classList.toggle('hidden', !s); }
        function showError(m) { errorMessage.textContent = m; errorMessage.classList.remove('hidden'); }
        function hideError() { errorMessage.classList.add('hidden'); }
    </script>
</body>
</html>
