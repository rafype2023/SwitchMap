<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cisco Switch Map Viewer - Puerto Rico</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SheetJS (xlsx) for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map {
            height: 65vh;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            background: #f3f4f6;
        }
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; }
        .legend { line-height: 18px; color: #555; }
        select[multiple] { height: 100px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">Cisco Switch Map Viewer</h1>
            <p class="text-gray-600 mt-2 font-medium">Puerto Rico Master Inventory & Deployment Visualization</p>
        </header>

        <!-- Upload Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex-1 w-full">
                    <label for="file-upload" class="block text-sm font-semibold text-gray-700 mb-2">Upload Master Inventory (.xlsx)</label>
                    <div class="flex items-center gap-2 flex-wrap">
                        <input id="file-upload" type="file" accept=".xlsx" class="block w-full md:w-auto text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                            file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700
                            hover:file:bg-indigo-100 transition-colors cursor-pointer">
                        <button id="load-data" class="px-5 py-2 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 shadow-sm transition-all whitespace-nowrap">Load Data</button>
                         <button id="load-url" class="px-5 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 shadow-sm transition-all whitespace-nowrap">Download Master File</button>
                    </div>
                </div>
                <div class="text-center md:text-right">
                     <a href="#" id="download-sample" class="text-sm font-semibold text-indigo-600 hover:underline">Download Template</a>
                </div>
            </div>
             <div id="loading" class="text-center mt-4 hidden">
                <p class="text-indigo-600 font-bold animate-pulse">Loading Inventory...</p>
            </div>
             <div id="error-message" class="text-center mt-4 text-red-600 hidden font-medium p-3 bg-red-50 rounded-md border border-red-100"></div>
        </div>

        <!-- Filters Section -->
        <div id="filter-section" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden border border-gray-200">
            <h3 class="text-lg font-bold mb-4 text-gray-900 flex items-center gap-2">Filters</h3>
            <div id="filter-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Location Type</label>
                    <select id="type-filter" multiple class="block w-full rounded border-gray-300 text-sm p-2"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Inventory Model</label>
                    <select id="switch-model-filter" multiple class="block w-full rounded border-gray-300 text-sm p-2"></select>
                </div>
                <div id="network-filter-wrapper">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Network Segment</label>
                    <select id="network-filter" multiple class="block w-full rounded border-gray-300 text-sm p-2"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Deployment Schedule</label>
                    <div class="space-y-2">
                        <input type="date" id="date-from" class="block w-full rounded border-gray-300 text-sm p-1">
                        <input type="date" id="date-to" class="block w-full rounded border-gray-300 text-sm p-1">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-3 border-t pt-4">
                <button id="apply-filters" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-md hover:bg-indigo-700 shadow-sm transition-all">Apply Filters</button>
                <button id="clear-filters" class="px-6 py-2 bg-gray-100 text-gray-600 font-bold rounded-md hover:bg-gray-200 transition-all">Reset All</button>
            </div>
        </div>

        <div id="map"></div>
         
        <div id="status-message" class="mt-4 text-gray-500 text-sm text-center py-4">
            Upload a Master Inventory file to begin.
        </div>

        <!-- Executive Dashboard -->
        <div id="executive-dashboard" class="mt-6 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Executive Dashboard
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Branch Progress -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Branch Deployment</h3>
                    <div class="flex items-end gap-2 mb-2">
                        <span id="dash-branch-pct" class="text-3xl font-bold text-gray-800">0%</span>
                        <span id="dash-branch-text" class="text-sm text-gray-500 mb-1">0 / 0 Completed</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-3 mb-1">
                        <div id="dash-branch-bar" class="bg-emerald-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Moex Progress -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Moex Deployment</h3>
                    <div class="flex items-end gap-2 mb-2">
                        <span id="dash-moex-pct" class="text-3xl font-bold text-gray-800">0%</span>
                        <span id="dash-moex-text" class="text-sm text-gray-500 mb-1">0 / 0 Completed</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-3 mb-1">
                        <div id="dash-moex-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Switches Collected -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 flex justify-between">
                        <span>Switches Collected</span>
                        <span id="dash-total-switches" class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">0 Total</span>
                    </h3>
                    <div id="dash-models-list" class="space-y-3 max-h-[250px] overflow-y-auto pr-2">
                        <!-- Model items injected here -->
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-400 text-[10px] uppercase tracking-widest pb-8">
            Version: 0206 | Build: 2501
        </footer>
    </div>

    <script>
        // --- Global Variables & Icons ---
        let allSwitchData = [];
        let map, markers;

        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const blackIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- OneDrive/SharePoint URL Construction Constants ---
        const SP_VIEWER_BASE = "https://intwoglobal-my.sharepoint.com/personal/luis_ramirez_intwo_cloud/_layouts/15/onedrive.aspx";
        const SP_VIEW_ID = "171ae644-fdd2-425d-b901-5927cc10a6ba";
        
        // Root path where "Fotos Serial y Tag" is located
        const SP_ROOT_PATH = "/personal/luis_ramirez_intwo_cloud/Documents/First Bank Swtiches 2026 Shared/Fotos Serial y Tag";
        const SP_CHECKLIST_PATH = "/personal/luis_ramirez_intwo_cloud/Documents/First Bank Swtiches 2026 Shared/Checklists Completed";
        
        // --- Helper to build the correct OneDrive Viewer URL for New Tab ---
        function buildOneDriveUrl(filename, subfolder = '', isChecklist = false) {
            let parentPath = isChecklist ? SP_CHECKLIST_PATH : SP_ROOT_PATH;
            
            if (subfolder && !isChecklist) {
                parentPath += "/" + subfolder;
            }

            const filePath = parentPath + "/" + filename;

            const encodedId = encodeURIComponent(filePath);
            const encodedParent = encodeURIComponent(parentPath);
            const encodedViewId = encodeURIComponent(SP_VIEW_ID);
            
            return `${SP_VIEWER_BASE}?viewid=${encodedViewId}&id=${encodedId}&parent=${encodedParent}`;
        }

        window.onload = function() { initMap(); };

        function initMap() {
            try {
                map = L.map('map').setView([18.2208, -66.5901], 9);
                markers = L.layerGroup().addTo(map);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function() {
                    const div = L.DomUtil.create('div', 'legend bg-white p-3 rounded shadow-lg border border-gray-100');
                    div.innerHTML = `<h4 class="font-bold text-xs uppercase text-gray-400 mb-2 border-b pb-1">Legend</h4>
                        <div class="flex items-center mb-1"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png" class="w-3 mr-2"> <span class="text-xs">Complete</span></div>
                        <div class="flex items-center mb-1"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png" class="w-3 mr-2"> <span class="text-xs">Branch</span></div>
                        <div class="flex items-center"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png" class="w-3 mr-2"> <span class="text-xs">Moex / Other</span></div>`;
                    return div;
                };
                legend.addTo(map);
            } catch (e) { console.error("Map failed:", e); }
        }

        // --- Data Helpers ---
        function getRowValue(row, possibleNames) {
            for (let name of possibleNames) {
                if (row.hasOwnProperty(name)) return row[name];
                const match = Object.keys(row).find(k => k.toLowerCase().trim() === name.toLowerCase().trim());
                if (match) return row[match];
            }
            return undefined;
        }

        function getTagValue(row, switchNum, isNew = false) {
            if (isNew) {
                if (switchNum === 1) return row['Tag 1_1'] || row['Tag 1'] || '-';
                if (switchNum === 2) return row['Tag 2_1'] || '-';
                if (switchNum === 3) return row['Tag 3_1'] || '-';
            } else {
                if (switchNum === 1) return row['TAG 1'] || '-';
                if (switchNum === 2) return row['Tag 2'] || '-';
                if (switchNum === 3) return row['Tag 3'] || '-';
            }
            return '-';
        }

        function renderNewTagLink(tagValue) {
            let tag = String(tagValue || '').trim();
            if (!tag || tag === '-' || tag.toLowerCase() === 'n/a') return '-';
            tag = tag.replace(/^#/, '').trim();
            const filename = `${tag}.jpeg`;
            // Tags are now in the 'Tags' subfolder
            const fullUrl = buildOneDriveUrl(filename, 'Tags');
            return `<a href="${fullUrl}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline font-bold" title="Open Tag Photo in New Tab">#${tag}</a>`;
        }

        function renderDeploymentImageLinks(ip) {
            const rawIp = String(ip || '').trim();
            if (!rawIp || rawIp === '-' || rawIp.toLowerCase() === 'n/a') return '';
            const dashIp = rawIp.replace(/\./g, '-');
            const beforeFile = `a${dashIp}.jpeg`;
            const afterFile = `d${dashIp}.jpeg`;
            
            // Deployment photos are now in the 'Racks' subfolder
            const beforeUrl = buildOneDriveUrl(beforeFile, 'Racks');
            const afterUrl = buildOneDriveUrl(afterFile, 'Racks');

            return `
                <div class="flex gap-2 mt-1">
                    <a href="${beforeUrl}" target="_blank" class="text-[10px] bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200 hover:bg-amber-200 font-bold no-underline inline-block transition-colors">Before</a>
                    <a href="${afterUrl}" target="_blank" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded border border-emerald-200 hover:bg-emerald-200 font-bold no-underline inline-block transition-colors">After</a>
                </div>`;
        }

        function renderChecklistLink(ip, isComplete) {
            const rawIp = String(ip || '').trim();
            if (!isComplete || !rawIp || rawIp === '-' || rawIp.toLowerCase() === 'n/a') return '';
            
            const dashIp = rawIp.replace(/\./g, '-');
            const filename = `check-${dashIp}.pdf`;
            const fullUrl = buildOneDriveUrl(filename, '', true); // true for Checklist path

            return `
                <div class="mb-3">
                    <span class="text-gray-400 font-bold uppercase text-[9px] block mb-1">Checklist</span>
                    <a href="${fullUrl}" target="_blank" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200 hover:bg-blue-200 font-bold no-underline inline-block transition-colors">
                        View Checklist
                    </a>
                </div>
            `;
        }

        // --- Core UI Logic ---
        const fileUpload = document.getElementById('file-upload');
        const loadDataButton = document.getElementById('load-data');
        const loadUrlButton = document.getElementById('load-url');
        const loadingIndicator = document.getElementById('loading');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const filterSection = document.getElementById('filter-section');
        const typeSelect = document.getElementById('type-filter');
        const modelSelect = document.getElementById('switch-model-filter');
        const networkSelect = document.getElementById('network-filter');
        const dateFromInput = document.getElementById('date-from');
        const dateToInput = document.getElementById('date-to');

        loadDataButton.addEventListener('click', handleFileUpload);
         loadUrlButton.addEventListener('click', handleUrlUpload);
        document.getElementById('apply-filters').addEventListener('click', plotDataOnMap);
        document.getElementById('clear-filters').addEventListener('click', () => {
            [modelSelect, typeSelect, networkSelect].forEach(s => Array.from(s.options).forEach(o => o.selected = false));
            plotDataOnMap();
        });

        function handleFileUpload() {
            const file = fileUpload.files[0];
            if (!file) return;
            showLoading(true);
            hideError();
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (json.length === 0) throw new Error("File empty");
                    allSwitchData = json;
                    initializeFilters(allSwitchData);
                    plotDataOnMap();
                    filterSection.classList.remove('hidden');
                } catch (err) { showError("Error reading file."); }
                finally { showLoading(false); }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleUrlUpload() {
            const url = "https://intwoglobal-my.sharepoint.com/:x:/r/personal/luis_ramirez_intwo_cloud/Documents/First%20Bank%20Swtiches%202026%20Shared/Copy%20of%20Calendario%20revisado-master%20file.xlsx?d=w982e582db91b495c8a9fc8ef467bbcf5&csf=1&web=1&e=Qo1cBy&download=1"; 
            window.open(url, '_blank');
            statusMessage.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded relative inline-block text-left" role="alert">
                    <strong class="font-bold">Download Started!</strong><br>
                    <span class="block sm:inline mt-1 text-sm">
                        1. Save the file to your computer.<br>
                        2. Use <b>"Choose File"</b> above.<br>
                        3. Click <b>"Load Data"</b>.
                    </span>
                </div>`;
            statusMessage.classList.remove('text-center');
        }

        function initializeFilters(data) {
            const models = new Set(), types = new Set(), networks = new Set(), dates = [];
            data.forEach(row => {
                ['Switch 1', 'Switch 2', 'Switch 3'].forEach(h => {
                    const m = getRowValue(row, [h]);
                    if (m && String(m).toUpperCase() !== 'N/A') models.add(String(m).trim());
                });
                const t = getRowValue(row, ['Branch or Moex', 'Type']);
                if (t) types.add(String(t).trim());
                const n = getRowValue(row, ['NETWORK', 'Network', 'Segment']);
                if (n && String(n).toUpperCase() !== 'N/A') networks.add(String(n).trim());
                const d = parseToDate(getRowValue(row, ['Date', 'Installation Date']));
                if (d) dates.push(d);
            });
            populateSelect(modelSelect, models);
            populateSelect(typeSelect, types);
            populateSelect(networkSelect, networks);
            if (dates.length > 0) {
                dateFromInput.value = new Date(Math.min(...dates)).toISOString().split('T')[0];
                dateToInput.value = new Date(Math.max(...dates)).toISOString().split('T')[0];
            }
        }

        function populateSelect(el, set) {
            el.innerHTML = '';
            Array.from(set).sort().forEach(val => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = val;
                el.appendChild(opt);
            });
        }

        function plotDataOnMap() {
            const selModels = Array.from(modelSelect.selectedOptions).map(o => o.value);
            const selTypes = Array.from(typeSelect.selectedOptions).map(o => o.value);
            const selNets = Array.from(networkSelect.selectedOptions).map(o => o.value);
            const from = dateFromInput.value ? new Date(dateFromInput.value) : null;
            const to = dateToInput.value ? new Date(dateToInput.value) : null;
            if (to) to.setHours(23,59,59);

            markers.clearLayers();
            let count = 0, swTotal = 0, sums = {};
            
            // Executive Dashboard Counters
            let dashBranchesTotal = 0, dashBranchesComp = 0;
            let dashMoexTotal = 0, dashMoexComp = 0;
            let collectedModels = {};
            let collectedTotal = 0;

            allSwitchData.forEach(row => {
                const lat = parseFloat(getRowValue(row, ['Latitude'])), lon = parseFloat(getRowValue(row, ['Longitude']));
                if (isNaN(lat) || isNaN(lon)) return;

                const rowDate = parseToDate(getRowValue(row, ['Date', 'Installation Date']));
                const s1 = getRowValue(row, ['Switch 1']), s2 = getRowValue(row, ['Switch 2']), s3 = getRowValue(row, ['Switch 3']);
                const type = String(getRowValue(row, ['Branch or Moex', 'Type']) || '').trim();
                const network = String(getRowValue(row, ['NETWORK', 'Network', 'Segment']) || '').trim();
                const closure = getRowValue(row, ['Hora de Cierre', 'Hora de Cieere']) || '-';

                const mMatch = selModels.length === 0 || [s1, s2, s3].some(s => selModels.includes(String(s || '').trim()));
                const tMatch = selTypes.length === 0 || selTypes.includes(type);
                const nMatch = selNets.length === 0 || selNets.includes(network);
                const dMatch = !rowDate || ((!from || rowDate >= from) && (!to || rowDate <= to));

                if (mMatch && tMatch && nMatch && dMatch) {
                    const complete = String(getRowValue(row, ['Complete']) || '').trim().toUpperCase() === 'Y';
                    const icon = complete ? redIcon : (type.toUpperCase() === 'BRANCH' ? greenIcon : blackIcon);
                    
                    // Populate Dashboard Counters
                    const typeUpper = type.toUpperCase();
                    if (typeUpper.includes('BRANCH')) {
                        dashBranchesTotal++;
                        if (complete) dashBranchesComp++;
                    } else if (typeUpper.includes('MOEX')) {
                        dashMoexTotal++;
                        if (complete) dashMoexComp++;
                    }

                    if (complete) {
                        [s1, s2, s3].forEach(s => {
                            if (s && String(s).toUpperCase() !== 'N/A' && !String(s).toUpperCase().includes('C9300')) {
                                const k = String(s).trim();
                                collectedModels[k] = (collectedModels[k] || 0) + 1;
                                collectedTotal++;
                            }
                        });
                    }

                    const popup = `<div class="min-w-[280px]">
                        <h3 class="font-bold text-gray-900 border-b pb-1 mb-2 text-sm flex justify-between">
                            <span>${getRowValue(row, ['Location']) || 'Site'}</span>
                            <span class="text-[9px] text-indigo-500 font-medium">Close: ${closure}</span>
                        </h3>
                        <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-[11px] mb-3">
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Pueblo</span> <span>${getRowValue(row, ['Pueblo']) || '-'}</span></div>
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Network IP</span> <span class="font-mono text-indigo-600">${network || '-'}</span></div>
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Software</span> <span>${getRowValue(row, ['Version']) || '-'}</span></div>
                            <div><span class="text-gray-400 font-bold uppercase text-[9px] block">Deployment</span> <span>${rowDate ? rowDate.toLocaleDateString() : '-'}</span></div>
                        </div>
                        <div class="mb-3">
                            <span class="text-gray-400 font-bold uppercase text-[9px] block mb-1 font-bold">Deployment Photos</span>
                            ${renderDeploymentImageLinks(network)}
                        </div>

                        ${renderChecklistLink(network, complete)}

                        <div class="bg-gray-50 p-2 rounded border border-gray-200 text-[10px] space-y-2 mb-2">
                            <b class="text-[9px] uppercase text-gray-400 block border-b pb-0.5">Inventory Reference</b>
                            <div><b>Sw1:</b> ${s1 || 'N/A'} <div class="text-gray-400 pl-2">S/N: ${getRowValue(row, ['Serial No-1']) || '-'} | Tag: ${getTagValue(row, 1, false)}</div></div>
                            ${s2 && s2 !== 'N/A' ? `<div><b>Sw2:</b> ${s2} <div class="text-gray-400 pl-2">S/N: ${getRowValue(row, ['Serial No-2']) || '-'} | Tag: ${getTagValue(row, 2, false)}</div></div>` : ''}
                            ${s3 && s3 !== 'N/A' ? `<div><b>Sw3:</b> ${s3} <div class="text-gray-400 pl-2">S/N: ${getRowValue(row, ['Serial No -3']) || '-'} | Tag: ${getTagValue(row, 3, false)}</div></div>` : ''}
                        </div>
                        <div class="bg-indigo-50/50 p-2 rounded border border-indigo-100 text-[10px] space-y-2">
                            <b class="text-[9px] uppercase text-indigo-400 block border-b border-indigo-100 pb-0.5 font-bold">New Deployment Data</b>
                            <div><b class="text-indigo-900">Sw1 New:</b> ${getRowValue(row, ['Serial No. No Switch 1']) || '-'} <div class="pl-2">Tag: ${renderNewTagLink(getTagValue(row, 1, true))}</div></div>
                            ${getRowValue(row, ['Serial No NEW  Switch 2']) ? `<div><b class="text-indigo-900">Sw2 New:</b> ${getRowValue(row, ['Serial No NEW  Switch 2'])} <div class="pl-2">Tag: ${renderNewTagLink(getTagValue(row, 2, true))}</div></div>` : ''}
                            ${getRowValue(row, ['Serial No. W Switch 3']) ? `<div><b class="text-indigo-900">Sw3 New:</b> ${getRowValue(row, ['Serial No. W Switch 3'])} <div class="pl-2">Tag: ${renderNewTagLink(getTagValue(row, 3, true))}</div></div>` : ''}
                        </div>
                    </div>`;

                    L.marker([lat, lon], { icon }).bindPopup(popup).addTo(markers);
                    count++;
                    [s1, s2, s3].forEach(s => {
                        if (s && String(s).toUpperCase() !== 'N/A') {
                            swTotal++;
                            const k = String(s).trim(); sums[k] = (sums[k] || 0) + 1;
                        }
                    });
                }
            });
            updateStatus(count, swTotal, sums);
            updateDashboard(dashBranchesTotal, dashBranchesComp, dashMoexTotal, dashMoexComp, collectedModels, collectedTotal);
        }

        function updateDashboard(bTotal, bComp, mTotal, mComp, models, modelsTotal) {
            const dashEl = document.getElementById('executive-dashboard');
            if (bTotal === 0 && mTotal === 0) {
                dashEl.classList.add('hidden');
                return;
            }
            dashEl.classList.remove('hidden');

            // Branch Stats
            const bPct = bTotal > 0 ? Math.round((bComp / bTotal) * 100) : 0;
            document.getElementById('dash-branch-pct').textContent = `${bPct}%`;
            document.getElementById('dash-branch-text').textContent = `${bComp} / ${bTotal} Completed`;
            document.getElementById('dash-branch-bar').style.width = `${bPct}%`;

            // Moex Stats
            const mPct = mTotal > 0 ? Math.round((mComp / mTotal) * 100) : 0;
            document.getElementById('dash-moex-pct').textContent = `${mPct}%`;
            document.getElementById('dash-moex-text').textContent = `${mComp} / ${mTotal} Completed`;
            document.getElementById('dash-moex-bar').style.width = `${mPct}%`;

            // Models List
            document.getElementById('dash-total-switches').textContent = `${modelsTotal} Total`;
            const modelsListEl = document.getElementById('dash-models-list');
            modelsListEl.innerHTML = '';
            
            const sortedModels = Object.entries(models).sort((a, b) => b[1] - a[1]);
            
            if (sortedModels.length === 0) {
                modelsListEl.innerHTML = '<div class="text-sm text-gray-400 italic">No old switches found in current filter.</div>';
            } else {
                sortedModels.forEach(([model, qty]) => {
                    const pct = Math.round((qty / modelsTotal) * 100);
                    modelsListEl.innerHTML += `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold text-gray-700">${model}</span>
                                <span class="text-gray-500 font-medium">${qty} units</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded h-1.5">
                                <div class="bg-indigo-400 h-1.5 rounded" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        function updateStatus(sites, total, sums) {
            if (sites > 0) {
                let breakdown = '<div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-2">';
                Object.keys(sums).sort().forEach(m => { breakdown += `<div class="text-[11px]"><b class="text-gray-600">${m}:</b> ${sums[m]}</div>`; });
                breakdown += '</div>';
                statusMessage.innerHTML = `<div class="bg-white p-4 rounded-lg border text-left">
                    <p class="font-bold text-indigo-900">${sites} Sites matched <span class="font-normal text-gray-400">(${total} units total)</span></p>
                    <p class="text-[10px] uppercase font-bold text-gray-300 mt-3 border-b">Inventory Breakdown</p>${breakdown}</div>`;
                statusMessage.classList.remove('text-center');
            } else {
                statusMessage.innerHTML = "No results found."; statusMessage.classList.add('text-center');
            }
        }

        function parseToDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number' && val > 30000 && val < 60000) return new Date((val - 25569) * 86400 * 1000);
            const d = new Date(val);
            return isNaN(d.getTime()) ? null : d;
        }

        function showLoading(s) { loadingIndicator.classList.toggle('hidden', !s); }
        function showError(m) { errorMessage.textContent = m; errorMessage.classList.remove('hidden'); }
        function hideError() { errorMessage.classList.add('hidden'); }

        function downloadSampleExcel(e) {
            e.preventDefault();
            const data = [{ Date: '2026-01-20', Location: 'Sample Plaza', Pueblo: 'San Juan', 'Branch or Moex': 'Branch', NETWORK: '10.0.1.1', Latitude: 18.46, Longitude: -66.11, 'Switch 1': 'C9300-48P', 'Serial No-1': 'OLD-SN', 'TAG 1': 'OLD-TAG', 'Serial No. No Switch 1': 'NEW-SN', 'Tag 1': '78819', Complete: 'N' }];
            const sheet = XLSX.utils.json_to_sheet(data);
            const book = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(book, sheet, 'Switches');
            XLSX.writeFile(book, 'Cisco_Map_Template.xlsx');
        }
    </script>
</body>
</html>
